aes(x = percentile_2.5, y = 0, xend = percentile_97.5, yend = 0),
linewidth = 2, color = "lightblue"
) +
geom_point(
data = stats_df,
aes(x = mean, y = 0), size = 1, color = "black"
) +
geom_vline(xintercept = 0, color = "gray") +
facet_grid(rows = vars(pipeline), scales = "free", switch = "y") +
labs(y = 'Posterior probability', x = 'Coefficient of CPP effect on drift rate') +
theme_bw() +
coord_cartesian(xlim = c(-0.05, 0.05), clip = "off") +
theme(
axis.text = element_text(size = 8),
panel.grid = element_blank(),
text = element_text(family = 'serif'),
panel.spacing = unit(0.2, "cm"),
strip.text.y = element_blank(),
strip.placement = "outside",
strip.background = element_blank(),
plot.margin = margin(r = 200)
) +
geom_text(
data = pipeline_labels,
aes(x = Inf, y = 0, label = label),
hjust = -0.1, vjust = -2, size = 4, family = 'serif'
)
data_full_plot <- do.call(rbind, data_full)
df_long <- data_full_plot %>%
dplyr::mutate(
feature = dplyr::case_match(suffix,
"slps" ~ "Build-up rate",
"ams" ~ "Amplitude",
"pams" ~ "Peak amplitude",
"slps_bin" ~ "Build-up rate",
"ams_bin" ~ "Amplitude",
"pams_bin" ~ "Peak amplitude"),
type = dplyr::case_when(
suffix %in% c("slps", "ams", "pams") ~ "Trial",
suffix %in% c("slps_bin", "ams_bin", "pams_bin") ~ "Bin"
),
pipeline = paste(type, feature, sep = "-")
) %>%
dplyr::mutate(
feature = factor(feature, levels = c("Build-up rate", "Amplitude", "Peak amplitude")),
type = factor(type, levels = c("Trial", "Bin")),
pipeline = factor(pipeline, levels = unique(pipeline))
)
# 5. Calculate mean and CI
stats_df <- df_long %>%
group_by(pipeline) %>%
summarise(
percentile_2.5 = quantile(mu, 0.025, na.rm = TRUE),
percentile_97.5 = quantile(mu, 0.975, na.rm = TRUE),
mean = mean(mu, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(mean)
# 6. Customize labels for plot
pipeline_labels <- data.frame(
pipeline = stats_df$pipeline,
label = c('Trialwise Build-up rate',
'Trialwise Amplitude',
'Trialwise Peak amplitude',
'Binwise Build-up rate',
'Binwise Amplitude',
'Binwise Peak amplitude')
)
# 7. plot
figure_main <- ggplot(df_long, aes(x = mu)) +
geom_histogram(aes(y = ..density..), bins = 100, alpha = 0.6, position = "identity")+
#geom_density() +
geom_segment(
data = stats_df,
aes(x = percentile_2.5, y = 0, xend = percentile_97.5, yend = 0),
linewidth = 2, color = "lightblue"
) +
geom_point(
data = stats_df,
aes(x = mean, y = 0), size = 1, color = "black"
) +
geom_vline(xintercept = 0, color = "gray") +
facet_grid(rows = vars(pipeline), scales = "free", switch = "y") +
labs(y = 'Posterior probability', x = 'Coefficient of CPP effect on drift rate') +
theme_bw() +
coord_cartesian(xlim = c(-0.05, 0.05), clip = "off") +
theme(
axis.text = element_text(size = 8),
panel.grid = element_blank(),
text = element_text(family = 'serif'),
panel.spacing = unit(0.2, "cm"),
strip.text.y = element_blank(),
strip.placement = "outside",
strip.background = element_blank(),
plot.margin = margin(r = 200)
) +
geom_text(
data = pipeline_labels,
aes(x = Inf, y = 0, label = label),
hjust = -0.1, vjust = -2, size = 4, family = 'serif'
)
figure_main+ggview::canvas(width = 200,height = 200*2/3, units = "mm", dpi = 320)
p <- plot(fit_RoBMA, parameter = "mu", plot_type = "ggplot")
class(p)
p +
labs(
x = "Coefficient of CPP effect on drift rate",
y = "Posterior density",
title = "Bayesian Meta-Analysis of CPP Effects"
)
p <- plot(fit_RoBMA, parameter = "mu", plot_type = "ggplot")
figure_custom <- p +
labs(
x = 'Coefficient of CPP effect on drift rate',
y = 'Posterior density'
) +
theme_bw() +
coord_cartesian(xlim = c(-0.05, 0.05)) +
theme(
axis.text = element_text(size = 8, family = 'serif'),
panel.grid = element_blank(),
text = element_text(family = 'serif')
)
print(figure_custom)
p <- plot(fit_RoBMA, parameter = "mu", plot_type = "ggplot")
figure_custom <- p +
labs(
x = 'Coefficient of CPP effect on drift rate',
y = 'Posterior density'
) +
theme_bw() +
coord_cartesian(xlim = c(-1, 1)) +
theme(
axis.text = element_text(size = 8, family = 'serif'),
panel.grid = element_blank(),
text = element_text(family = 'serif')
)
print(figure_custom)
p <- plot(fit_RoBMA, parameter = "mu", plot_type = "ggplot")
figure_custom <- p +
theme_bw() +
coord_cartesian(xlim = c(-1, 1)) +
theme(
axis.text = element_text(size = 8, family = 'serif'),
panel.grid = element_blank(),
text = element_text(family = 'serif')+
labs(
x = 'Coefficient of CPP effect on drift rate',
y = 'Posterior density'
)
)
data_full_plot <- do.call(rbind, data_full)
df_long <- data_full_plot %>%
dplyr::mutate(
feature = dplyr::case_match(suffix,
"slps" ~ "Build-up rate",
"ams" ~ "Amplitude",
"pams" ~ "Peak amplitude",
"slps_bin" ~ "Build-up rate",
"ams_bin" ~ "Amplitude",
"pams_bin" ~ "Peak amplitude"),
type = dplyr::case_when(
suffix %in% c("slps", "ams", "pams") ~ "Trial",
suffix %in% c("slps_bin", "ams_bin", "pams_bin") ~ "Bin"
),
pipeline = paste(type, feature, sep = "-")
) %>%
dplyr::mutate(
feature = factor(feature, levels = c("Build-up rate", "Amplitude", "Peak amplitude")),
type = factor(type, levels = c("Trial", "Bin")),
pipeline = factor(pipeline, levels = unique(pipeline))
)
# 5. Calculate mean and CI
stats_df <- df_long %>%
group_by(pipeline) %>%
summarise(
percentile_2.5 = quantile(mu, 0.025, na.rm = TRUE),
percentile_97.5 = quantile(mu, 0.975, na.rm = TRUE),
mean = mean(mu, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(mean)
# 6. Customize labels for plot
pipeline_labels <- data.frame(
pipeline = stats_df$pipeline,
label = c('Trialwise Build-up rate',
'Trialwise Amplitude',
'Trialwise Peak amplitude',
'Binwise Build-up rate',
'Binwise Amplitude',
'Binwise Peak amplitude')
)
# 7. plot
figure_main <- ggplot(df_long, aes(x = mu)) +
geom_density() +
geom_segment(
data = stats_df,
aes(x = percentile_2.5, y = 0, xend = percentile_97.5, yend = 0),
linewidth = 2, color = "lightblue"
) +
geom_point(
data = stats_df,
aes(x = mean, y = 0), size = 1, color = "black"
) +
geom_vline(xintercept = 0, color = "gray") +
facet_grid(rows = vars(pipeline), scales = "free", switch = "y") +
labs(y = 'Posterior probability', x = 'Coefficient of CPP effect on drift rate') +
theme_bw() +
coord_cartesian(xlim = c(-0.05, 0.05), clip = "off") +
theme(
axis.text = element_text(size = 8),
panel.grid = element_blank(),
text = element_text(family = 'serif'),
panel.spacing = unit(0.2, "cm"),
strip.text.y = element_blank(),
strip.placement = "outside",
strip.background = element_blank(),
plot.margin = margin(r = 200)
) +
geom_text(
data = pipeline_labels,
aes(x = Inf, y = 0, label = label),
hjust = -0.1, vjust = -2, size = 4, family = 'serif'
)
figure_main+ggview::canvas(width = 200,height = 200*2/3, units = "mm", dpi = 320)
p <- plot(fit_RoBMA, parameter = "mu", plot_type = "ggplot")
if ("ggplot" %in% class(p)) {
p +
theme_bw() +
coord_cartesian(xlim = c(-0.05, 0.05)) +
labs(x = "Coefficient", y = "Density")
}
p <- plot(fit_RoBMA, parameter = "mu", plot_type = "ggplot")
if ("ggplot" %in% class(p)) {
p +
theme_bw() +
coord_cartesian(xlim = c(-0.05, 0.05)) +
labs(x = "Coefficient", y = "a")
}
p <- plot(fit_RoBMA, parameter = "mu", plot_type = "ggplot")
if ("ggplot" %in% class(p)) {
p +
theme_bw() +
coord_cartesian(xlim = c(-1, 1)) +
labs(x = "Coefficient", y = "a")
}
p <- plot(fit_RoBMA, parameter = "mu", plot_type = "ggplot")
p
summary(fit_RoBMA)
View(df_long)
a <- extract_posterior(fit_RoBMA, parameter = "mu", conditional = FALSE)
View(a)
identical(a, mu)
mu = fit_RoBMA$RoBMA$posteriors$mu
identical(a, mu)
a <- extract_posterior(fit_RoBMA, parameter = "mu", conditional = FALSE)
mu <- fit_RoBMA$RoBMA$posteriors$mu
identical(a, mu)
View(a)
# Set prior for RoBMA
priors_effect <- prior("normal", parameters = list(mean = 0, sd = 1))
priors_heterogeneity_invgamma <- prior("invgamma", parameters = list(shape = 1, scale = 0.15))
suffixes <- c("slps", "ams")#, "pams", "slps_bin", "ams_bin", "pams_bin")
datasets <- c('high_Sun_2023', 'high_Moerel_2024')
data_full <- list()
for (pipeline in suffixes) {
data_RoBMA_pipe <- data.frame()
for (dataset in datasets) {
path <- glue("./{dataset}/results/ddm/m2_{pipeline}_posterior.csv")
df <- read.csv(path)
# Extract mean and std for posterior
mean <- mean(df[,1])
sd   <- sd(df[,1])
name <- dataset
data_RoBMA_pipe <- rbind(data_RoBMA_pipe,
data.frame(mean = mean,
se   = sd,
name = name))
}
# Fit RoBMA
fit_RoBMA <- RoBMA(d = data_RoBMA_pipe$mean, se = data_RoBMA_pipe$se, study_names = data_RoBMA_pipe$name,
priors_effect = priors_effect,
priors_heterogeneity = priors_heterogeneity_invgamma,
priors_bias = set_default_priors("bias", rescale = 1),
sample = 500, burnin = 100,
seed = 42
)
mu = extract_posterior(fit_RoBMA, parameter = "mu", conditional = FALSE)
data_full[[pipeline]] <- data.frame(mu = mu,
suffix = pipeline)
}
install.packages("progress")
library(progress)
data_full_plot <- do.call(rbind, data_full)
df_long <- data_full_plot %>%
dplyr::mutate(
feature = dplyr::case_match(suffix,
"slps" ~ "Build-up rate",
"ams" ~ "Amplitude",
"pams" ~ "Peak amplitude",
"slps_bin" ~ "Build-up rate",
"ams_bin" ~ "Amplitude",
"pams_bin" ~ "Peak amplitude"),
type = dplyr::case_when(
suffix %in% c("slps", "ams", "pams") ~ "Trial",
suffix %in% c("slps_bin", "ams_bin", "pams_bin") ~ "Bin"
),
pipeline = paste(type, feature, sep = "-")
) %>%
dplyr::mutate(
feature = factor(feature, levels = c("Build-up rate", "Amplitude", "Peak amplitude")),
type = factor(type, levels = c("Trial", "Bin")),
pipeline = factor(pipeline, levels = unique(pipeline))
)
# 5. Calculate mean and CI
stats_df <- df_long %>%
group_by(pipeline) %>%
summarise(
percentile_2.5 = quantile(mu, 0.025, na.rm = TRUE),
percentile_97.5 = quantile(mu, 0.975, na.rm = TRUE),
mean = mean(mu, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(mean)
# 6. Customize labels for plot
pipeline_labels <- data.frame(
pipeline = stats_df$pipeline,
label = c('Trialwise Build-up rate',
'Trialwise Amplitude',
'Trialwise Peak amplitude',
'Binwise Build-up rate',
'Binwise Amplitude',
'Binwise Peak amplitude')
)
# 7. plot
figure_main <- ggplot(df_long, aes(x = mu)) +
geom_density() +
geom_segment(
data = stats_df,
aes(x = percentile_2.5, y = 0, xend = percentile_97.5, yend = 0),
linewidth = 2, color = "lightblue"
) +
geom_point(
data = stats_df,
aes(x = mean, y = 0), size = 1, color = "black"
) +
geom_vline(xintercept = 0, color = "gray") +
facet_grid(rows = vars(pipeline), scales = "free", switch = "y") +
labs(y = 'Posterior probability', x = 'Coefficient of CPP effect on drift rate') +
theme_bw() +
coord_cartesian(xlim = c(-0.05, 0.05), clip = "off") +
theme(
axis.text = element_text(size = 8),
panel.grid = element_blank(),
text = element_text(family = 'serif'),
panel.spacing = unit(0.2, "cm"),
strip.text.y = element_blank(),
strip.placement = "outside",
strip.background = element_blank(),
plot.margin = margin(r = 200)
) +
geom_text(
data = pipeline_labels,
aes(x = Inf, y = 0, label = label),
hjust = -0.1, vjust = -2, size = 4, family = 'serif'
)
figure_main+ggview::canvas(width = 200,height = 200*2/3, units = "mm", dpi = 320)
View(data_full)
View(data_full_plot)
library(BayesTools)
BayesTools::plot_posterior(
samples = list(mu = mu),
parameter = "mu",
plot_type = "ggplot"
)
mu_samples <- RoBMA:::.extract_posterior.RoBMA(fit_RoBMA, "mu", conditional = FALSE)$mu
BayesTools::plot_posterior(
samples = list(mu = mu_samples),
parameter = "mu",
plot_type = "ggplot"
)
plot(fit_RoBMA, parameter = "mu", xlim = c(-0.5, 0.5))
mu_samples <- RoBMA:::.extract_posterior.RoBMA(fit_RoBMA, "mu", conditional = FALSE)$mu
BayesTools::plot_posterior(
samples = list(mu = mu_samples),
parameter = "mu",
plot_type = "ggplot"
)
plot(fit_RoBMA, parameter = "mu", xlim = c(-0.5, 0.5))
mu_samples <- RoBMA:::.extract_posterior.RoBMA(fit_RoBMA, "mu", conditional = FALSE)$mu
BayesTools::plot_posterior(
samples = list(mu = mu_samples),
parameter = "mu",
plot_type = "ggplot"
)
plot(fit_RoBMA, parameter = "mu", xlim = c(-0.5, 0.7))
mu_samples <- RoBMA:::.extract_posterior.RoBMA(fit_RoBMA, "mu", conditional = FALSE)$mu
BayesTools::plot_posterior(
samples = list(mu = mu_samples),
parameter = "mu",
plot_type = "ggplot"
)
plot(fit_RoBMA, parameter = "mu", xlim = c(-0.5, 1))
sum(mu_samples[1]==1)
sum(mu_samples[1]==0)
n_zeros      <- sum(mu_samples == 0)
total_n      <- length(mu_samples)
prop_zeros   <- n_zeros / total_n
n_zeros / total_n
sum(mu_samples == 0)
n_zeros / total_n
mu_samples <- RoBMA:::.extract_posterior.RoBMA(fit_RoBMA, "mu", conditional = FALSE)$mu
BayesTools::plot_posterior(
samples = list(mu = mu_samples),
parameter = "mu",
plot_type = "ggplot"
)
plot(fit_RoBMA, parameter = "mu", xlim = c(-0.5, 1))
View(data_RoBMA_pipe)
summary(fit_RoBMA)
View(data_RoBMA_pipe)
set.seed(123)  # Set a random seed for reproducibility
# Load required packages using pacman
require(pacman)
p_load("boot", "tidyverse", "reshape2", "brms", "bruceR", "BayesFactor", "nlme", "lme4", "patchwork")
set.seed(123)  # Set a random seed for reproducibility
# Read the preprocessed data from a CSV file
df <- read.csv('/Users/hyijie/Desktop/data4two_steps.csv')
View(df)
# Extract the relevant columns (slp and v) for analysis
data <- data.frame(df[,c('slps','v_posterior')])
# Perform bootstrapping to estimate the correlation and its confidence intervals
b <- boot(data, statistic = corr.stats, R = 1000)  # Perform 1000 bootstrap resamples
# 1. 定义 corr.stats 函数
corr.stats <- function(data, indices) {
d <- data[indices, ]  # 提取 bootstrap 样本
cor(d[, 1], d[, 2])   # 计算两列的相关系数
}
View(data)
# Extract the relevant columns (slp and v) for analysis
data <- data.frame(df[,c('slps','v_posterior')])
# Perform bootstrapping to estimate the correlation and its confidence intervals
b <- boot(data, statistic = corr.stats, R = 1000)  # Perform 1000 bootstrap resamples
conf.int <- boot.ci(b, type = "basic")[['basic']]  # Calculate the basic confidence interval
# Calculate the observed correlation between slp and v
corr.observed <- corr.stats(data, 1:nrow(data))
# Create a density plot of the bootstrapped correlation statistics
density_data <- density(data.frame(b$t)$b.t)
# Plot the bootstrapped correlation distribution with confidence intervals
ggplot(data.frame(b$t), aes(x = b.t)) +
geom_density() +  # Plot the density curve
geom_vline(xintercept = 0,  # Add a vertical line at 0 for reference
color = "grey",
linetype = 2) +
geom_area(data = subset(as.data.frame(density_data[c("x", "y")]), x >= conf.int[4] & x <= conf.int[5]),
aes(x = x, y = y),  # Highlight the area between the confidence intervals
fill = "lightblue",
alpha = 0.5) +
theme_bw()  # Use a clean black and white theme
pipeline <- names(df)[4:9]
pipeline <- names(df)[4:9]
for pipe in pipeline{
pipeline <- names(df)[4:9]
for (pipe in pipeline) {
# Extract the relevant columns (slp and v) for analysis
data <- data.frame(df[,c(pipe,'v_posterior')])
# Perform bootstrapping to estimate the correlation and its confidence intervals
b <- boot(data, statistic = corr.stats, R = 1000)  # Perform 1000 bootstrap resamples
conf.int <- boot.ci(b, type = "basic")[['basic']]  # Calculate the basic confidence interval
# Calculate the observed correlation between slp and v
corr.observed <- corr.stats(data, 1:nrow(data))
# Create a density plot of the bootstrapped correlation statistics
density_data <- density(data.frame(b$t)$b.t)
# Plot the bootstrapped correlation distribution with confidence intervals
ggplot(data.frame(b$t), aes(x = b.t)) +
geom_density() +  # Plot the density curve
geom_vline(xintercept = 0,  # Add a vertical line at 0 for reference
color = "grey",
linetype = 2) +
geom_area(data = subset(as.data.frame(density_data[c("x", "y")]), x >= conf.int[4] & x <= conf.int[5]),
aes(x = x, y = y),  # Highlight the area between the confidence intervals
fill = "lightblue",
alpha = 0.5) +
theme_bw()  # Use a clean black and white theme
}
View(b)
pipeline <- names(df)[4:9]
plots <- vector("list", length(pipeline))
for (pipe in pipeline) {
# Extract the relevant columns (slp and v) for analysis
data <- data.frame(df[,c(pipe,'v_posterior')])
# Perform bootstrapping to estimate the correlation and its confidence intervals
b <- boot(data, statistic = corr.stats, R = 1000)  # Perform 1000 bootstrap resamples
conf.int <- boot.ci(b, type = "basic")[['basic']]  # Calculate the basic confidence interval
# Calculate the observed correlation between slp and v
corr.observed <- corr.stats(data, 1:nrow(data))
# Create a density plot of the bootstrapped correlation statistics
density_data <- density(data.frame(b$t)$b.t)
# Plot the bootstrapped correlation distribution with confidence intervals
p <- ggplot(data.frame(b$t), aes(x = b.t)) +
geom_density() +  # Plot the density curve
geom_vline(xintercept = 0,  # Add a vertical line at 0 for reference
color = "grey",
linetype = 2) +
geom_area(data = subset(as.data.frame(density_data[c("x", "y")]), x >= conf.int[4] & x <= conf.int[5]),
aes(x = x, y = y),  # Highlight the area between the confidence intervals
fill = "lightblue",
alpha = 0.5) +
theme_bw()  # Use a clean black and white theme
plots[[pipe]] <- p
}
print(plots)
