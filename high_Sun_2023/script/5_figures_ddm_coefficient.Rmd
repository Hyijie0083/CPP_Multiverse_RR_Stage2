```{r}
library(pacman)
p_load('tidyverse','patchwork','ggridges','viridis','ggview')

```


```{r demo}
# Load the raw data from a CSV file
df_task1_vcoef <- read.csv('../results/ddm/m2_ams_posterior.csv')
# Calculate the 2.5th percentile, 97.5th percentile, and mean for the 3rd column
percentile_2.5 <- quantile(df_task1_vcoef[,1], 0.025)
percentile_97.5 <- quantile(df_task1_vcoef[,1], 0.975)
mean_value <- mean(df_task1_vcoef[,1])
#showing the posterior probability density distribution of the coefficient
figure_4a <- ggplot(df_task1_vcoef, aes(x = df_task1_vcoef[, 1])) +
  geom_density() +
  geom_segment(aes(x = percentile_2.5, y = 0, xend = percentile_97.5, yend = 0),linewidth = 2,color = "lightblue") +
  geom_point(aes(x = mean_value, y = 0),size = 1,color = "black") +geom_vline(xintercept = 0, color = "gray")+
  labs(y = 'Posterior probability', x = 'Coefficient of CPP effect on drift rate') +
  theme_bw() +
  coord_cartesian(xlim = c(-1, 1)) +
  theme(axis.text = element_text(size = 6),panel.grid = element_blank(),text = element_text(family = 'serif'),panel.spacing = unit(0.1, "cm"))+
  ggview::canvas(width = 200,height = 200*2/3, units = "mm", dpi = 320)

```

```{r figure for coefficient}
# 1. define suffix and labels
suffixes <- c("slps", "ams", "pams", "slps_bin", "ams_bin", "pams_bin")
feature_labels <- c("slps" = "Build-up rate", 
                    "ams" = "Amplitude", 
                    "pams" = "Peak amplitude")
type_labels <- c("slps" = "Trial", "ams" = "Trial", "pams" = "Trial",
                 "slps_bin" = "Bin", "ams_bin" = "Bin", "pams_bin" = "Bin")

# 2. Define a function to load data
extract_vcoef <- function(suffix, col_index = 1) {
  path <- glue::glue("../results/ddm/m2_{suffix}_posterior.csv")
  if (!file.exists(path)) {
    warning("File not found: ", path)
    return(tibble(v = numeric(0), suffix = suffix))
  }
  df <- read.csv(path)
  tibble(v = df[[col_index]], suffix = suffix)
}

# 3. Use function to all models
df_list <- map_dfr(suffixes, ~ extract_vcoef(.x, col_index = 1))

# 4. 添加可读标签
df_long <- df_list %>%
  mutate(
    feature = case_match(suffix,
                         "slps" ~ "Build-up rate",
                         "ams" ~ "Amplitude",
                         "pams" ~ "Peak amplitude",
                         "slps_bin" ~ "Build-up rate",
                         "ams_bin" ~ "Amplitude",
                         "pams_bin" ~ "Peak amplitude"),
    type = case_match(suffix,
                      "slps" | "ams" | "pams" ~ "Trial",
                      "slps_bin" | "ams_bin" | "pams_bin" ~ "Bin"),
    pipeline = paste(type, feature, sep = "-")
  ) %>%
  mutate(
    feature = factor(feature, levels = c("Build-up rate", "Amplitude", "Peak amplitude")),
    type = factor(type, levels = c("Trial", "Bin")),
    pipeline = factor(pipeline, levels = unique(pipeline))
  )

# 5. Calculate mean and CI
stats_df <- df_long %>%
  group_by(pipeline) %>%
  summarise(
    percentile_2.5 = quantile(v, 0.025, na.rm = TRUE),
    percentile_97.5 = quantile(v, 0.975, na.rm = TRUE),
    mean = mean(v, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(mean)

# 6. Customize labels for plot
pipeline_labels <- data.frame(
  pipeline = stats_df$pipeline,
  label = c('Trialwise Build-up rate',
            'Trialwise Amplitude',
            'Trialwise Peak amplitude',
            'Binwise Build-up rate',
            'Binwise Amplitude',
            'Binwise Peak amplitude')
)

# 7. plot
figure <- ggplot(df_long, aes(x = v)) +
  geom_density() +
  geom_segment(
    data = stats_df,
    aes(x = percentile_2.5, y = 0, xend = percentile_97.5, yend = 0),
    linewidth = 2, color = "lightblue"
  ) +
  geom_point(
    data = stats_df,
    aes(x = mean, y = 0), size = 1, color = "black"
  ) +
  geom_vline(xintercept = 0, color = "gray") +
  facet_grid(rows = vars(pipeline), scales = "free", switch = "y") +
  labs(y = 'Posterior probability', x = 'Coefficient of CPP effect on drift rate') +
  theme_bw() +
  coord_cartesian(xlim = c(-1, 1), clip = "off") +
  theme(
    axis.text = element_text(size = 8),
    panel.grid = element_blank(),
    text = element_text(family = 'serif'),
    panel.spacing = unit(0.2, "cm"),
    strip.text.y = element_blank(),
    strip.placement = "outside",
    strip.background = element_blank(),
    plot.margin = margin(r = 200)
  ) +
  geom_text(
    data = pipeline_labels,
    aes(x = Inf, y = 0, label = label),
    hjust = -0.1, vjust = -2, size = 4, family = 'serif'
  )

print(figure)

```

